# とこめも 要件定義 v1.0（MVP・Codex実装用）

> 本書は **要求レベル**での完成版。これ1本でMVPの実装を開始・完遂できることを目的とする（DB詳細設計は別）。

---

## 1. 目的・スコープ

* **目的**：個人/カップルで「行きたい/行った/再訪したい」スポットを管理し、写真・訪問記録・AI補完で入力負荷を下げる。
* **対象スポット**：飲食店・遊びスポット・観光地・寺社・施設など汎用。
* **非スコープ（MVP）**：公開リンク、エクスポート、外部住所API、Cloudflare Images、サブリンク保存、i18n（日本語のみ）。

---

## 2. プラットフォーム / インフラ

* **Webアプリ（PWA）**：モバイル優先、ダーク/ライト/システム。
* **ホスティング**：Cloudflare Pages/Workers。
* **ストレージ**：Cloudflare R2（画像保存・配信）。
* **DB/認証**：Supabase（無料プラン開始）。
* **解析**：Cloudflare Web Analytics（最小イベント送信）。

---

## 3. 認証・アカウント

* **方式**：メール **マジックリンク + Google ログイン**。
* **セッション保持**：30日。
* **同意**：アカウント作成時に **利用規約/プライバシーに同意**（バージョンと時刻を記録）。
* **マジックリンク再送**：送信後 60 秒のクールダウンを表示し、カウントダウン中は再送ボタンを無効化。リンク未踏の状態では同一メールでも再送を許容する。
* **リンクエラー時の案内**：検証に失敗したマジックリンクで訪問した場合は初期ページに戻し、バナーでリンク切れ／期限切れを案内し再送を促す。
* **未完成登録時の滞留**：セッションがあるがニックネーム登録が完了していない場合は `/` 上のヘッダや設定の CTA で任意登録を促し、Couple 共有機能の利用は登録完了まで保留する。
* **対応ブラウザ/OS**：Chrome / Safari / Firefox の**最新2版**。

---

## 4. リストと共有

* **個人リスト（Personal）**：自分だけが見える。既定。
* **共有リスト（Shared）**：ペアリング相手と共有。
* **表示切替**：タブUI（個人／共有）。
* **ペアリング**：
  * 設定画面で「コード発行（ランダム4桁-4桁）」→「相手のコード入力」。
  * 成功すると **双方の `partner_id` が更新** される（相互リンク）。
  * 1人1ペアまで。
* **ペア解除**：**即時解除**＋共有リストは**双方に自動コピー**（以後は各自の個人リストとして独立）。

---

## 5. スポット・モデル（要求レベル項目）

> DBスキーマは別設計。本章は「保持すべきフィールド」の要求定義。

### 5.1 基本

* **ID**：UUID。
* **名前（必須）**：自由テキスト。
* **URL**：公式サイト/食べログ/GoogleMap等。AI補完の起点。
* **スコープ**：Personal / Shared。
* **ステータス編集**：詳細モーダルで**3段トグル**（行きたい／行った／再訪したい）。初期=行きたい、自動遷移=初回訪問追加→行った（手動で再訪したいに変更可）。

### 5.2 住所/地図

* **住所**：自由テキスト（正規化軽微）。
* **地図リンク**：**詳細画面のみ**生成。優先：**住所＞名前**でGoogleマップ検索URL。新規登録画面には**地図UIは出さない**。

### 5.3 営業時間

* **週次入力（日本語曜日）**：`日/月/火/水/木/金/土` 各行に例：`11:00–20:00`, `休み`, `11:00–14:00, 17:00–21:00`。
* **自由メモ**：例外（祝日/臨時休業/LO等）。
* **“営業中”バッジ**：週次入力があるカードのみ **JST** 判定で表示。

### 5.4 価格/支払い

* **価格帯**：JPY整数、**下限/上限**の2フィールド（どちらか片方でも可）。
* **決済手段**：チェックボックス **複数選択可**（MVPはハードコード）。例：
  * 現金
  * クレジット：Visa / Mastercard / Amex / JCB / （必要に応じて）
  * 交通系IC：Suica/PASMO 他
  * QR：PayPay / 楽天ペイ / d払い / au PAY
  * 電子マネー：iD / QUICPay
  * 予備：**クレジット可（ブランド不明）**
  * 自由追記（1行）

### 5.5 写真

* **入力**：カメラ起動＋ギャラリー複数選択（同一編集セッション内で他項目と一括保存）。
* **保存形式**：**JPEGに統一**（受付は JPEG/PNG/HEIC/WebP）。
* **変換**：長辺 **1280–1600px**、目標 **200KB**、ソフト上限 **300KB**、ハード上限 **500KB**。EXIF削除、向き補正、透過は**白合成**。
* **並び替え**：ドラッグで可能。**先頭＝表紙**（一覧サムネ）。
* **上限**：**総100枚/人・月50枚/人・日10枚/人**（訪問記録の写真も**合算**）。
* **ストレージ警告**：**80%で黄**、**100%で赤＋アップロード不可**。
* **保存先/命名/配信**：R2に保存。`{userId}/{yyyy}/{mm}/{contentHash}.jpg`。`Cache-Control: public, immutable, max-age=31536000`。

### 5.6 訪問記録

* **フィールド**：
  * **日付（必須／既定=今日）** ※時刻なし
  * **評価★（1〜5、1刻み）**
  * **会計（JPY整数：合計のみ）**
  * **メモ（≤1000、URLリンク化）**
  * **写真**（写真上限に合算）
* **並び**：**新しい日付が上（降順）**。
* **一覧表示**：詳細内は**最新3件**だけ展開＋「すべて表示」。
* **編集導線**：各行の **︙ メニュー→［編集/削除］**。削除は確認必須。

---

## 6. AI補完（Gemini 2.5 Flash-Liteを想定）

* **起点**：**URL欄が有効**であれば**新規登録中でも実行可**（保存前OK）。
* **上書き対象**：名前/電話/住所/営業時間/価格/決済/カテゴリ/タグ候補 等（**URLは上書きしない**）。
* **確認**：実行前に「入力済みの事実系を上書きします。実行しますか？」。
* **取り消し**：今回の適用だけ**元に戻す**（保存前に限る）。
* **タグ自動追加**：AIは**最大10個まで**タグを追加してよい（総上限10を超えない）。
* **回数上限**：
  * **日10回/人**、**月100回/人**、**同じカード＝5回/日**。
  * **未保存でもカウント**（失敗も1回計上）。
* **制御**：**タイムアウト20秒＋リトライ1回**（合計最長≦約40秒）。
* **失敗表示**：短文＋コード（`AI_TIMEOUT` 等）。

---

## 7. 一覧・検索・フィルター

* **取得**：無限スクロール＋フッター「さらに読み込む」、**1回=20件**。
* **検索バー**：**常時表示（一覧上部）**。対象＝**名前・メモ・タグ**（前方/部分一致、かな/全半角正規化）。
* **フィルターUI**：上部**チップ型**。タグ=複数選択（既定=**OR**／設定で**AND**切替可）、ステータス（行きたい/行った/再訪）トグル。
* **並び替え**：**最新編集順（既定）／名前昇順／評価が高い順／最新訪問日**。
* **お気に入り**：⭐トグル（**個人単位**）。一覧ではピン付きが**最上段**。
* **重複ヒント**：同一リスト内だけ**入力中サジェスト**＋**保存直前の最終確認**（ブロックはしない）。
* **空表示**：ガイド文＋［＋ 新規登録］（共有タブは「ペアリングへ」導線も）。

---

## 8. 新規登録 / 詳細・編集（UI要件）

### 8.1 新規登録モーダル（FABで `/` 上に展開）

* **ファーストビュー**：
  * 名前（必須、フォーカス）
  * URL ＋ 右に **「AIで補完」** ボタン（URL未入力は非活性）
  * 画面下：**［キャンセル｜登録］**（固定フッター）
* **少スクロールで表示**：写真（「写真を追加」ボタン→選択後はサムネ）、タグ、メモ。
* **折りたたみ無し**（初回の見落とし防止）。

### 8.2 詳細モーダル（保存後）

* **初期状態**：**すべて開く**。
* **見出し**：**写真／基本情報／住所・地図／営業時間／価格・支払い／訪問記録／メモ**。
* **閉じ方**：**×ボタン＋背景タップ**（**下スワイプは無効**）。未保存時は離脱確認。
* **写真表示**：上部 **カルーセル**（拡大ビューあり）。編集時は同セッションで並び替え/追加/削除。
* **移動/ミラー**：詳細の **︙メニュー**に「共有へ移動／個人へ移動／**両方に表示**／このタブから外す」。

---

## 9. 通知

* **初期設定**：**すべてOFF**（設定でON）。
* **チャネル**：**アプリ内のみ**（バナー/スナックバー）。
* **文面**：スポット名のみ。
  * 共有更新：`「{スポット名}」が更新されました`
  * 訪問追加：`「{スポット名}」に訪問記録を追加しました`
  * AI完了：`「{スポット名}」のAI補完が完了しました`
* **頻度**：**5分バッチ**（同一スポットの連続更新はまとめる）。

---

## 10. 設定画面（最小の4セクション）

* **プロフィール**：表示名（1–30）・アイコン（任意、≤1MB、正方形トリミング、最長辺256px）。
* **通知**：3種トグル（共有更新/訪問追加/AI完了）。
* **ストレージ**：総100・月50のメーター表示、警告ロジック（80/100%）。**ヘッダーのアカウントメニューにも小メーターを表示**。写真追加UIにもカウンタを常時表示。
* **アプリ**：テーマ＝システム/ライト/ダーク。**検索設定**：タグ絞り込みの既定**OR**／**AND**切替トグル。
* **サポート**：メールリンク（ドメイン確定後に`support@...`へ差し替え）。

---

## 11. エラー表示（ユーザー向け）

* **方針**：短文＋分類コード。
* **例**：
  * 画像が大きすぎます（`IMG_SIZE`）
  * 画像形式が無効です（`IMG_TYPE`）
  * AI補完に失敗しました（`AI_TIMEOUT`）
  * 保存に失敗しました（`SAVE_FAIL`）
  * リクエストが多すぎます（`RATE_LIMITED`）

---

## 12. レート制限（MVP想定）

* **未認証**：**10 req/分**（IP、バースト20/30秒）。
* **認証済み**：**30 req/分**（ユーザーID、バースト15/10秒）。
* **エンドポイント別**：
  * AI補完：**4 req/分**
  * 画像アップロード：**3 req/分 & 30 req/時**
  * 新規作成/更新：**6 req/分**
  * ペアリング検証：**2 req/分・20 req/時**
  * サインイン開始：**3 req/時**
* **429表示**：`RATE_LIMITED` の短文のみ。

---

## 13. データ保持・法務

* **解析イベント（最小）**：起動/新規保存/AI補完（押下/成功/失敗/キャンセル）/写真アップ（成功/失敗）/リスト種別属性。ユーザーIDは**ハッシュ**、**内容テキストは送らない**。保持**90日**。
* **アカウント削除**：**30日保留→完全削除**（DB・R2画像も物理削除）。
* **バックアップ**：Supabaseの**自動バックアップを有効**。**月1回**リストア手順の点検（演習）を実施。
* **TOS/PP**：フッター固定リンク。改定時のみ再同意。

---

## 14. PWA / オンボーディング / オフライン

* **PWAインストール促進**：**2回目起動で控えめバナー**（拒否→30日再提示なし）。
* **オンボーディング**：**3枚以内＋スキップ可**（①「＋で追加」②「個人/共有」③「AIで補完」）。
* **オフライン**：ホーム/詳細の**基本キャッシュ**（軽め）。**自動ドラフト保存なし**（明示保存のみ）。

---

## 15. 非機能要件（MVP）

* **パフォーマンス**：主要操作のTTI≦3s（4G相当）、画像は遅延読み込み。
* **アクセシビリティ**：タップ領域≥44px、色コントラストAA相当（キーボード操作は対象外）。
* **セキュリティ**：RLS/認可（Supabase）、CSRF/XSS対策、MIMEスニッフィング、画像サニタイズ（EXIF除去）。
* **ログ**：サーバエラーログ保持 90日、個人情報は含めない。

---

## 16. 画面・導線（概略）

* **ホーム**（タブ：個人／共有）
  * 検索バー（常時）／フィルタチップ／並び替え
  * 無限スクロール（20件/回）
  * カード：サムネ小・タイトル1行・メモ冒頭1行・タグ（横スクロール）・**最新訪問日＋累計回数**・⭐ピン
  * FAB：**＋ → `/` 上でスポット登録モーダル（SpotForm）を表示**
* **新規登録**：A'配置（主要=名前・URL・フッター保存が一画面／写真・タグ・メモは少スクロール）
* **詳細モーダル**：写真カルーセル→基本情報→住所・地図→営業時間→価格/支払い→訪問記録→メモ。︙メニューに移動/ミラー/外す/削除。

---

## 17. 受入基準（抜粋）

* **保存時**：名前のみで保存成功し、**ステータス=行きたい**になる。
* **AI補完**：URL有効時、保存前でも実行可能。**URLは上書きされない**。回数制限に従う。
* **画像**：PNG/HEIC/WebPをアップしても**JPEGで保存**され、目標圧縮・上限チェックが働く。
* **重複ヒント**：同一リスト内で入力中と保存直前に出るが、保存は可能。
* **ミラー**：同じカードが個人/共有の両方に表示され、片方で編集しても両方に反映。削除は両方から消える。外す操作で片方から非表示。
* **訪問記録**：最新3件だけ展開、並びは降順、行の︙から編集/削除可能。
* **通知**：既定OFF、アプリ内のみ、文面はスポット名のみ、5分バッチ。
* **PWA**：2回目起動でインストールバナーが出る（拒否後30日は出ない）。

---

## 18. 将来拡張メモ（実装不要）

* 公開リンク（個別カード/読み取り専用）
* 外部住所/ジオコーディングAPI
* 選択肢のリモート設定（決済/タグプリセット）
* Webプッシュ、Googleフォーム問い合わせ
* 解析の詳細化（ファネル）